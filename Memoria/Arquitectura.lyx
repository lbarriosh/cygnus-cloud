#LyX 2.0 created this file. For more info see http://www.lyx.org/
\lyxformat 413
\begin_document
\begin_header
\textclass memoir
\use_default_options true
\maintain_unincluded_children false
\language spanish
\language_package default
\inputencoding auto
\fontencoding global
\font_roman default
\font_sans default
\font_typewriter default
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100
\font_tt_scale 100

\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\float_placement H
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry false
\use_amsmath 1
\use_esint 1
\use_mhchem 1
\use_mathdots 1
\cite_engine basic
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\use_refstyle 1
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation skip
\defskip smallskip
\quotes_language english
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Chapter
Arquitectura del sistema
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
TODO: meter referencias noVNC, KVM y Twisted
\end_layout

\end_inset


\end_layout

\begin_layout Section
Introducción
\end_layout

\begin_layout Standard
En este capítulo presentaremos una visión general de la arquitectura de
 
\emph on
CygnusCloud
\emph default
.
 Para facilitar su comprensión, hemos intentado que la claridad prevalezca
 a la hora de exponer los distintos conceptos y decisiones de diseño.
 Por ello, evitaremos a toda costa realizar descripciones exhaustivas de
 todas y cada una de las clases y de sus distintos atributos.
 Si el lector desea conocer con total precisión qué atributos y qué métodos
 tiene cada clase, cómo se comporta cierto método o cuál es la finalidad
 de un determinado atributo, le remitimos al código fuente, extensamente
 comentado.
\end_layout

\begin_layout Standard
Por otra parte, en este capítulo también prestaremos especial atención a
 las decisiones de diseño que hemos tomado ya que, a nuestro parecer, son
 fundamentales para comprender el funcionamiento del sistema, sus ventajas
 y sus limitaciones.
\end_layout

\begin_layout Subsection
Visión general
\end_layout

\begin_layout Standard
Los contenidos de este capítulo se agrupan en las siguientes secciones:
\end_layout

\begin_layout Enumerate
La presente 
\series bold
introducción
\series default
.
\end_layout

\begin_layout Enumerate

\series bold
Objetivos de la arquitectura y restricciones
\series default
.
 En esta sección expondremos todos los objetivos que se tuvieron al diseñar
 
\emph on
CygnusCloud
\emph default
, y también recopilaremos las restricciones con las que hemos tenido que
 tratar a lo largo de todo el proceso de diseño.
\end_layout

\begin_layout Enumerate

\series bold
Subsistemas de 
\emph on
CygnusCloud
\series default
\emph default
.
 En esta sección mostraremos, en términos generales, qué subsistemas componen
 
\emph on
CygnusCloud 
\emph default
y qué responsabilidades tienen asignadas.
 Esta información es fundamental para comprender la arquitectura, y por
 ello aparece antes de presentar todas las vistas de la misma.
\end_layout

\begin_layout Enumerate

\series bold
Vista lógica
\series default
.
 En esta sección, mostraremos cómo las funciones de cada subsistema se distribuy
en entre sus distintos módulos con la ayuda de un diagrama de paquetes.
 Además, utilizaremos diagramas de clase y diagramas de secuencia para exponer
 las responsabilidades de cada elemento significativo de la arquitectura
 y sus relaciones con el resto de componentes de la misma.
\end_layout

\begin_layout Enumerate

\series bold
Vista de procesos
\series default
.
 En ella mostraremos el funcionamiento de cada subsistema desde el punto
 de vista de los procesos ligeros o 
\emph on
threads
\emph default
, y también discutiremos el cometido de los mismos.
\end_layout

\begin_layout Enumerate

\series bold
Vista de despliegue
\series default
.
 En esta sección mostraremos cómo se distribuyen los distintos subsistemas
 que forman parte de 
\emph on
CygnusCloud
\emph default
 entre las distintas máquinas que forman parte de la infraestructura utilizada.
\end_layout

\begin_layout Enumerate

\series bold
Vista de implementación
\series default
.
 Concluiremos el presente capítulo con esta sección, en la que describiremos
 los componentes que se distribuyen con cada subsistema.
\end_layout

\begin_layout Subsection
Sobre los diagramas UML de este documento
\end_layout

\begin_layout Standard
Para que el aumento del tamaño de los diagramas UML en un lector de ficheros
 PDF no suponga una pérdida de calidad de los mismos, hemos procurado incrustarl
os en este documento como ficheros 
\family typewriter
.pdf
\family default
.
\end_layout

\begin_layout Standard
El comando de 
\emph on
IBM Rational Software Architect 7.5
\emph default
 que los genera usa degradados para mejorar la presentación de los diagramas
 de clase y de los diagramas de paquetes, haciendo que los elementos que
 aparecen en la parte superior del diagrama sean más oscuros que los que
 aparecen en la parte inferior del mismo.
\end_layout

\begin_layout Standard
En cualquier caso, este efecto 
\emph on
no
\emph default
 tiene asociado ningún tipo de significado en los diagramas.
\end_layout

\begin_layout Section
Objetivos de la arquitectura y restricciones
\end_layout

\begin_layout Standard
En esta sección describiremos todos los objetivos que consideramos a la
 hora de diseñar la arquitectura, así como las restricciones que hemos tenido
 en cuenta a lo largo de todo el proceso de diseño.
\end_layout

\begin_layout Subsection
Objetivos
\end_layout

\begin_layout Standard
Con 
\emph on
CygnusCloud
\emph default
 no sólo queremos proporcionar a los estudiantes de la Facultad de Informática
 más laboratorios en los que trabajar: también queremos ofrecer una alternativa
 viable para que cualquier alumno pueda sacar el máximo partido a cualquier
 aula de informática infrautilizada del campus.
 Por ello, la 
\emph on
escalabilidad 
\emph default
es una característica fundamental del diseño: utilizando más servidores
 y más ancho de banda, es posible que 
\emph on
CygnusCloud
\emph default
 atienda a un mayor número de usuarios.
 
\end_layout

\begin_layout Standard
Además, para que alumnos y profesores de cualquier titulación sean capaces
 de utilizar 
\emph on
CygnusCloud 
\emph default
en cualquier aula de informática, nuestro sistema debe ser 
\emph on
fácil de usar
\emph default
, y también debe poder utilizarse sin necesidad de instalar 
\emph on
software
\emph default
 en dichas aulas.
\end_layout

\begin_layout Standard
Por otra parte, considerando la actual situación de crisis económica, también
 deseamos que 
\emph on
CygnusCloud
\emph default
 sirva para mostrar cómo sacar el máximo partido a los recursos informáticos
 existentes en la Universidad.
 Así, 
\emph on
CygnusCloud
\emph default
 debe poder implantarse con 
\emph on
coste cero
\emph default
, lo que nos ha obligado a buscar la 
\emph on
eficiencia
\emph default
 a la hora de diseñarlo.
\end_layout

\begin_layout Standard
Finalmente, dado que el desarrollo de 
\emph on
CygnusCloud 
\emph default
sólo se extiende a lo largo de un curso académico, también queremos que
 cualquiera que lo desee pueda continuarlo.
 Por ello, hemos procurado que nuestro diseño también se caracterice por
 su 
\emph on
simplicidad
\emph default
: en todos los procesos se sigue siempre una secuencia de pasos muy marcados,
 que sólo varía en función de las características de las máquinas que intervenga
n.
\end_layout

\begin_layout Subsection
Restricciones
\begin_inset CommandInset label
LatexCommand label
name "sub:Restricciones-arquitectura"

\end_inset


\end_layout

\begin_layout Standard
Tal y como mencionamos en el apartado anterior, 
\emph on
CygnusCloud
\emph default
 debe poder implantarse con coste cero.
 Para ello, es imprescindible construir este sistema con 
\emph on
software
\emph default
 gratuito.
 Como los hipervisores deben instalarse en un sistema operativo en concreto,
 que tiene que ser gratuito, esto ha impuesto la primera restricción importante:
 la 
\emph on
dependencia de la plataforma GNU/Linux
\emph default
.
 
\end_layout

\begin_layout Standard
Y dado que existe una ingente cantidad de distribuciones 
\emph on
GNU/Linux
\emph default
 que pueden requerir procedimientos de configuración diferentes, es fundamental
 utilizar mecanismos estándar para interactuar con los hipervisores y, a
 ser posible, lenguajes interpretados, para garantizar que nuestro sistema
 funcione sin problemas en cualquier sistema 
\emph on
GNU/Linux
\emph default
.
 Esto ha impuesto una doble restricción: 
\end_layout

\begin_layout Itemize
el uso obligatorio de la librería 
\emph on
libvirt 
\emph default
para interactuar con los hipervisores y configurar las redes virtuales.
\end_layout

\begin_layout Itemize
el uso de un lenguaje de tipo interpretado, como Java o Python, como principal
 lenguaje de programación.
\end_layout

\begin_layout Standard
Por otra parte, la práctica totalidad de los 
\emph on
frameworks
\emph default
 que hemos considerado para implementar la web se basan en el modelo vista-contr
olador o en otros patrones de diseño derivados de él, lo que nos ha obligado
 a utilizar dicho patrón de en el servidor web.
\end_layout

\begin_layout Standard
Finalmente, para evitar la aparición de incompatibilidades entre formatos
 de paquete hemos tenido que utilizar la misma librería de red para comunicar
 todos los subsistemas que componen 
\emph on
CygnusCloud
\emph default
.
 Puesto que cada librería de red está implementada en cierto lenguaje, nos
 hemos visto obligados a emplear el mismo lenguaje de programación para
 implementar la mayoría de subsistemas, lo que también ha restringido significat
ivamente el número de 
\emph on
frameworks
\emph default
 que hemos podido considerar para implementar la web.
\end_layout

\begin_layout Section
Subsistemas de 
\emph on
CygnusCloud
\end_layout

\begin_layout Standard
El sistema 
\emph on
CygnusCloud
\emph default
 está formado por un conjunto de susbsistemas conectados a una misma red
 que cooperan entre sí para suministrar servicios a los usuarios.
 Cada uno de estos subsistemas tiene una funcionalidad claramente delimitada,
 y residirá en una máquina posiblemente distinta.
\end_layout

\begin_layout Standard
Los subsistemas básicos que componen 
\emph on
CygnusCloud
\emph default
 y sus principales responsabilidades son los siguientes:
\end_layout

\begin_layout Itemize
el 
\series bold
servidor de máquinas virtuales
\series default
 reside en todas las máquinas que alojarán las máquinas virtuales de los
 usuarios.
 Su misión es interactuar con el hipervisor en respuesta a las peticiones
 recibidas para instanciar y destruir máquinas virtuales, enviar los datos
 de conexión a cada máquina virtual, suministrar estadísticas que reflejen
 su estado actual,\SpecialChar \ldots{}

\end_layout

\begin_layout Itemize
el 
\series bold
servidor del 
\emph on
cluster
\series default
\emph default
 reside en una máquina asignada a cada 
\emph on
cluster
\emph default
 de servidores de máquinas virtuales.
 Además de realizar el balanceado de carga para distribuir las máquinas
 virtuales entre los distintos servidores de máquinas virtuales del 
\emph on
cluster
\emph default
, también recopila periódicamente el estado de todos sus servidores de máquinas
 virtuales.
\end_layout

\begin_layout Itemize
el 
\series bold
servidor web
\series default
 reside en una única máquina.
 Su misión es alojar la web, que permite a los usuarios utilizar el sistema
 
\emph on
CygnusCloud
\emph default
.
 Este sistema realiza el control de acceso, recopila periódicamente información
 de estado desde todos los servidores de 
\emph on
cluster
\emph default
 y envía a los mismos todas las peticiones de los usuarios.
\end_layout

\begin_layout Standard

\emph on
CygnusCloud
\emph default
 también está compuesto por dos subsistemas adicionales: el 
\series bold
cliente de escritorio remoto noVNC
\series default
 y el 
\series bold
hipervisor
\series default
 
\series bold
KVM
\series default
.
 Puesto que ambos han sido desarrollados por terceros, en este capítulo
 sólo hablaremos de ellos en líneas generales y sólo cuando sea imprescindible
 para comprender el funcionamiento del sistema.
 
\end_layout

\begin_layout Standard
\begin_inset Newpage clearpage
\end_inset


\end_layout

\begin_layout Section
Vista lógica
\end_layout

\begin_layout Subsection
Visión general
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/DiagramaPaquetes.pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Diagrama-de-paquetes-CygnusCloud"

\end_inset

Diagrama de paquetes de 
\emph on
CygnusCloud
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
La funcionalidad del sistema 
\emph on
CygnusCloud 
\emph default
está distribuida entre siete paquetes:
\end_layout

\begin_layout Itemize
en los módulos del paquete 
\family sans
utils
\family default
 se definen clases que se utilizan en varios módulos distintos, como estructuras
 de datos sin problemas de sincronización o clases que ejecutan comandos.
 
\end_layout

\begin_layout Itemize
el paquete 
\family sans
database
\family default
 contiene todas las clases que interactuarán con las bases de datos de los
 tres subsistemas básicos.
 
\end_layout

\begin_layout Itemize
el paquete 
\family sans
network
\family default
 contiene las clases que permiten comunicar un conjunto de máquinas distintas
 a través de una red de área local.
 Dichas comunicaciones se realizan utilizando el protocolo TCP a través
 de la librería de red 
\emph on
twisted
\emph default
.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
virtualMachineServer
\family default
 contiene las clases que, junto con algunas de los paquetes de los que este
 depende, implementan el subsistema servidor de máquinas virtuales.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
clusterServer
\family default
 contiene todas las clases que, junto con algunas de los paquetes de los
 que este depende, implementan el susbsistema servidor del 
\emph on
cluster
\emph default
.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
webServer
\family default
 contiene todas las clases que, junto con algunas de los paquetes de los
 que este depende, implementan el susbsistema servidor web.
\end_layout

\begin_layout Itemize
finalmente, el paquete 
\family sans
testing
\family default
 contiene clases utilizadas para depurar los sistemas servidor de máquinas
 virtuales y servidor del 
\emph on
cluster
\emph default
.
\end_layout

\begin_layout Standard
Las relaciones existentes entre estos paquetes aparecen en la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Diagrama-de-paquetes-CygnusCloud"

\end_inset

.
 Por claridad, las dependencias del paquete 
\family sans
virtualMachineServer
\family default
 aparecen en 
\color red
rojo
\color inherit
, las del paquete 
\family sans
clusterServer
\family default
 aparecen en 
\color blue
azul
\color inherit
 y las del resto de paquetes aparecen en negro.
\end_layout

\begin_layout Standard
Los paquetes que acabamos de presentar se descomponen en otros paquetes
 más pequeños.
 Para facilitar la visualización de las dependencias principales entre paquetes,
 hemos optado por no mostrar aquí dicha dicha descomposición.
 Mostraremos la descomposición de cada paquete y las relaciones entre clases
 que justifican la dependencia entre esos paquetes a medida que presentemos
 el diseño.
\end_layout

\begin_layout Subsection
Paquetes y clases significativos de la arquitectura
\end_layout

\begin_layout Standard
En este apartado mostraremos las clases más importantes de cada paquete
 junto con una breve descripción de sus responsabilidades.
\end_layout

\begin_layout Subsubsection

\family sans
utils
\end_layout

\begin_layout Standard
Como ya hemos mencionado, este paquete define un conjunto de clases que
 se utilizan en muchos otros y que, por conveniencia, es mejor tener agrupadas.
 Las clases más relevantes de este paquete son las siguientes:
\end_layout

\begin_layout Itemize

\family sans
Commands
\family default
.
 Esta clase suministra métodos estáticos que permiten ejecutar comandos
 en 
\emph on
foreground
\emph default
 y 
\emph on
background
\emph default
, y también como 
\emph on
root
\emph default
 o como un usuario estándar.
\end_layout

\begin_layout Itemize

\family sans
MultithreadingCounter
\family default
.
 Esta clase almacena el valor de un contador, y dispone de métodos para
 incrementarlo, decrementarlo y leer su valor de forma segura cuando varios
 hilos lo utilizan.
\end_layout

\begin_layout Itemize
Las clases 
\family sans
MultithreadingDictionary
\family default
 y 
\family sans
MultithreadingList
\family default
 definen métodos para manipular de forma segura diccionarios y listas Python
 utilizados por varios hilos.
\end_layout

\begin_layout Itemize
La clase 
\family sans
MultithreadingPriorityQueue
\family default
 define métodos para manipular una cola de prioridad utilizada por varios
 hilos.
\end_layout

\begin_layout Itemize
Las clases 
\family sans
BasicThread
\family default
 y 
\family sans
QueueProcessingThread
\family default
 añaden funcionalidad adicional a los hilos estándar de Python para que
 estos se detengan ante las peticiones de otros y para que procesen una
 cola de elementos respectivamente.
\end_layout

\begin_layout Subsubsection

\family sans
database
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/DiagramaPaquetesDatabase.pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:El-paquete-database"

\end_inset

El paquete 
\family sans
database
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Este paquete contiene todas las clases que interactuarán con las bases de
 datos de los distintos susbsistemas de 
\emph on
CygnusCloud
\emph default
.
 Tal y como se muestra en la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:El-paquete-database"

\end_inset

, estas clases se distribuyen en cinco subpaquetes:
\end_layout

\begin_layout Itemize
el paquete 
\family sans
utils
\family default
 contiene todas las clases que permiten interactuar con una base de datos
 MySQL desde Python.
 De entre todas ellas, destacan
\family sans
 DBConfigurator
\family default
 y 
\family sans
BasicDatabaseConnector
\family default
, que permiten configurar el esquema de una base de datos y realizar consultas
 y actualizaciones sobre una base de datos respectivamente.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
clusterServer
\family default
 contiene la clase 
\family sans
ClusterServerDatabaseConnector
\family default
, que permite manipular la base de datos del servidor del 
\emph on
cluster
\emph default
.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
systemStatus
\family default
 contiene la clase 
\family sans
SystemStatusDBWriter
\family default
, que permite actualizar la base de datos que almacena el estado de todo
 el sistema.
\end_layout

\begin_layout Itemize
el paquete
\family sans
 vmServer
\family default
 contiene las clases 
\family sans
ImageManager
\family default
 y 
\family sans
RuntimeData
\family default
, que permiten manipular la base de datos del servidor de máquinas virtuales.
\end_layout

\begin_layout Itemize
finalmente, el paquete 
\family sans
tests
\family default
 contiene pruebas unitarias de todas las clases que manipulan una base de
 datos.
\end_layout

\begin_layout Subsubsection

\family sans
network
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/DiagramaPaquetesNetwork.pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:El-paquete-network"

\end_inset

El paquete 
\family sans
network
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
Las clases del paquete 
\family sans
network
\family default
 interactúan con la librería de red 
\emph on
twisted
\emph default
 para comunicar una máquina con otra u otras conectadas a la misma red.
 La figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:El-paquete-network"

\end_inset

 muestra que este paquete se descompone en seis subpaquetes:
\end_layout

\begin_layout Itemize
el paquete 
\family sans
exceptions
\family default
 contiene todas las clases de excepción que utilizan las clases del paquete
 
\family sans
network
\family default
.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
packets
\family default
 contiene la clase 
\family sans
Packet
\family default
, que ofrece una interfaz de alto nivel para enviar elementos de los tipos
 de datos básicos (como valores enteros y 
\emph on
strings
\emph default
) a través de la red.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
threads
\family default
 contiene las clases 
\family sans
ConnectionMonitoringThread
\family default
, 
\family sans
DataProcessingThread
\family default
, 
\family sans
TwistedReactorThread
\family default
 y 
\family sans
ServerWaitThread
\family default
, correspondientes a los distintos tipos de hilo que se utilizan en la implement
ación de la red.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
twistedInteraction
\family default
 contiene las clases 
\family sans
NetworkConnection
\family default
 y 
\family sans
CygnusCloudProtocol
\family default
, que se utilizan para establecer conexiones y para realizar el envío y
 la recepción de datos utilizando la librería de red 
\emph on
twisted
\emph default
.
\end_layout

\begin_layout Itemize
el paquete 
\family sans
manager
\family default
 contiene las clases 
\family sans
NetworkManager
\family default
 y 
\family sans
NetworkCallback
\family default
.
 La primera ofrece una interfaz de alto nivel para establecer una conexión
 entre dos máquinas y enviar datos entre las mismas, y la segunda define
 la interfaz que se utiliza para procesar los datos recibidos a través de
 la red.
\end_layout

\begin_layout Itemize
finalmente, el paquete
\family sans
 tests
\family default
 contiene pruebas de los módulos de este paquete.
\end_layout

\begin_layout Subsubsection

\family sans
virtualMachineServer
\end_layout

\begin_layout Standard
Este paquete contiene las clases del subsistema servidor de máquinas virtuales
 que interactuan con el hipervisor y también las de mayor nivel de abstracción
 de dicho subsistema.
 Las más importante son las siguientes:
\end_layout

\begin_layout Itemize

\family sans
LibvirtConnector
\family default
, que interactúa con el hipervisor KVM a través de la librería 
\emph on
libvir
\emph default
t para instanciar y destruir máquinas virtuales.
\end_layout

\begin_layout Itemize

\family sans
VMClient
\family default
, que atiende las peticiones recibidas por el servidor de máquinas virtuales.
 Entre otras cosas, se ocupa de asignar y liberar los recursos asociados
 a cada máquina virtual y de ordenar la instanciación y la destrucción de
 las mismas.
\end_layout

\begin_layout Itemize

\family sans
ConfigurationFileEditor
\family default
, que manipula los ficheros 
\family typewriter
.xml
\family default
 que definen la configuración de una máquina virtual para incluir los recursos
 asociados a dicha máquina.
\end_layout

\begin_layout Itemize

\family sans
VMServerPacketHandler
\family default
, que proporciona métodos para crear y leer los paquetes utilizados por
 el subsistema servidor de máquinas virtuales.
 
\end_layout

\begin_layout Itemize

\family sans
VirtualNetworkManager
\family default
, que configura la red virtual a la que se conectarán las máquinas virtuales.
\end_layout

\begin_layout Subsubsection

\family sans
clusterServer
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/DiagramaPaquetesClusterServer.pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:El-paquete-clusterServer"

\end_inset

El paquete 
\family sans
clusterServer
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
Tal y como se muestra en la figura , el paquete 
\family sans
clusterServer
\family default
, que contiene las clases del subsistema servidor del cluster de mayor nivel
 de abstracción, consta de tres subpaquetes:
\end_layout

\begin_layout Itemize
el paquete 
\family sans
network
\family default
 contiene las clases 
\family sans
WebCallback
\family default
, 
\family sans
VMServerCallback
\family default
 y 
\family sans
MainServerPacketHandle
\family default
r.
 Las dos primeras definen los métodos a los que se llamará cuando se reciba
 un paquete procedente del servidor web y de un servidor de máquinas virtuales
 respectivamente, y la última se comporta igual que la clase 
\family sans
VMServerPacketHandler
\family default
, proporcionando métodos para leer y crear los paquetes que utiliza el servidor
 del 
\emph on
cluster
\emph default
 para comunicarse con el servidor web.
\end_layout

\begin_layout Itemize
el paquete l
\family sans
oadBalancing
\family default
 contiene la clase 
\family sans
LoadBalancer
\family default
, que define la interfaz que usarán todos los distintos algoritmos que realizan
 el balanceado de carga entre distintos servidores de máquinas virtuales.
\end_layout

\begin_layout Itemize
finalmente, el paquete 
\family sans
reactor
\family default
 contiene la clase 
\family sans
MainServerReactor
\family default
, que procesa adecuadamente los paquetes recibidos desde un servidor de
 máquinas virtuales o desde el servidor web.
\end_layout

\begin_layout Subsubsection

\family sans
webServer
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
TODO: rellenar esto
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection

\family sans
testing
\end_layout

\begin_layout Standard
El paquete 
\family sans
testing
\family default
 contiene clases que permiten comprobar el correcto funcionamiento de los
 subsistemas servidor de máquinas virtuales y servidor del cluster.
 Sus clases son las siguientes:
\end_layout

\begin_layout Itemize

\family sans
DummyVMServer
\family default
, que imita el comportamiento de un servidor de máquinas virtuales y no
 instancia máquinas.
 Esta clase se utiliza para comprobar el funcionamiento del subsistema servidor
 del cluster.
\end_layout

\begin_layout Itemize

\family sans
VirtualMachineServerTester
\family default
.
 Esta clase imita al servidor principal, haciendo posible el envío de cualquier
 secuencia de órdenes a un servidor de máquinas virtuales.
 Por ello, se utiliza para depurar dicho subsistema.
\end_layout

\begin_layout Itemize

\family sans
ClusterServerTester
\family default
.
 Esta clase imita al servidor web, lo que permite enviar cualquier secuencia
 de órdenes a un servidor de 
\emph on
cluster
\emph default
.
 Así, esta clase se utiliza para depurar este subsistema.
\end_layout

\begin_layout Subsection
Decisiones de diseño
\end_layout

\begin_layout Standard
En esta sección discutiremos brevemente las decisiones de diseño más importantes
 que hemos tomado a lo largo del desarrollo del proyecto.
\end_layout

\begin_layout Subsubsection
Uso de 
\emph on
Python
\emph default
 como principal lenguaje de programación
\end_layout

\begin_layout Standard
Tal y como mencionamos en la sección 
\begin_inset CommandInset ref
LatexCommand ref
reference "sub:Restricciones-arquitectura"

\end_inset

, debido a las distintas características y procedimientos de configuración
 de las distribuciones 
\emph on
GNU/Linux
\emph default
, es altamente recomendable utilizar lenguajes interpretados para facilitar
 la portabilidad del sistema.
 Los lenguajes de este tipo que consideramos al inicio del proyecto fueron
 esencialmente dos: 
\emph on
Java
\emph default
 y 
\emph on
Python
\emph default
.
 
\end_layout

\begin_layout Standard
El uso de 
\emph on
Python 
\emph default
tenía las siguientes ventajas:
\end_layout

\begin_layout Itemize
el grado de adopción de 
\emph on
Python
\emph default
 no ha hecho más que crecer a lo largo de los últimos años, por lo que aprender
 a utilizarlo era muy importante para mejorar nuestras perspectivas laborales.
\end_layout

\begin_layout Itemize
a diferencia de 
\emph on
Java
\emph default
, 
\emph on
Python
\emph default
 es 
\emph on
software
\emph default
 libre, por lo que sus restricciones de uso son considerablemente menores
 que las de 
\emph on
Java
\emph default
.
\end_layout

\begin_layout Itemize
la interacción entre 
\emph on
scripts
\emph default
 y programas escritos en 
\emph on
Python
\emph default
 es claramente mejor en 
\emph on
Python
\emph default
 que en Java.
\end_layout

\begin_layout Itemize
los programas escritos en 
\emph on
Python
\emph default
 son mucho más breves y más fáciles de leer que los programas escritos en
 
\emph on
Java
\emph default
, lo que facilita la comprensión del código y su depuración.
 
\end_layout

\begin_layout Itemize
para ejecutar un programa 
\emph on
Python
\emph default
 se utiliza su propio código fuente, lo que facilita enormemente la resolución
 de los problemas que aparecen al utilizar componentes de terceros.
\end_layout

\begin_layout Itemize

\emph on
Python
\emph default
 forma parte de la instalación estándar de la inmensa mayoría de distribuciones
 
\emph on
GNU/Linux
\emph default
, lo que simplifica el proceso de instalación de 
\emph on
CygnusCloud
\emph default
.
\end_layout

\begin_layout Standard
Los grandes inconvenientes del uso de 
\emph on
Python
\emph default
 eran principalmente dos:
\end_layout

\begin_layout Itemize
era necesario aprender a utilizar una tecnología nueva, cosa que no ocurría
 en el caso de 
\emph on
Java
\emph default
.
\end_layout

\begin_layout Itemize
en general, hay muchas más bibliotecas y 
\emph on
frameworks
\emph default
 escritos en 
\emph on
Java
\emph default
 que escritos en 
\emph on
Python
\emph default
, lo que limitaba las alternativas que podíamos considerar a lo largo del
 desarrollo del proyecto.
\end_layout

\begin_layout Standard
Ante el gran número de ventajas que tenía el uso de 
\emph on
Python
\emph default
, estos dos inconvenientes nos parecieron aceptables, por lo que decidimos
 utilizar 
\emph on
Python
\emph default
 como principal lenguaje de programación.
\end_layout

\begin_layout Subsubsection
Descomposición del sistema 
\emph on
CygnusCloud
\emph default
 en tres subsistemas
\end_layout

\begin_layout Standard
Instanciar una máquina virtual requiere muchos recursos.
 No basta con asignarle memoria RAM y tiempo de CPU: también es necesario
 reservar espacio en disco en el que almacenar los datos de los usuarios
 y los archivos de paginación, conectar la máquina a una red, configurar
 un servidor de escritorio remoto o un servidor SSH para poder acceder a
 ella,\SpecialChar \ldots{}

\end_layout

\begin_layout Standard
Así pues, para que nuestro sistema sea escalable, es imprescindible la existenci
a de nodos que alberguen exclusivamente máquinas virtuales y que se ocupen
 de su instanciación y descomposición: los 
\series bold
servidores de máquinas virtuales
\series default
.
 
\end_layout

\begin_layout Standard
Por otra parte, es necesario distribuir las máquinas virtuales activas entre
 todos estos nodos y recopilar información de estado, por lo que es necesario
 utilizar al menos una máquina adicional, a la que llamaremos por ahora
 
\begin_inset Quotes eld
\end_inset

servidor principal
\begin_inset Quotes erd
\end_inset

.
 Esta hipotética máquina también debería albergar la web, a través de la
 cual los usuarios utilizan el sistema.
 
\end_layout

\begin_layout Standard
Es importante notar que, una vez instanciadas las máquinas virtuales, los
 usuarios se comunican directamente con un servidor de máquinas virtuales,
 es decir, el tráfico generado por el protocolo VNC y el tráfico generado
 para conectarse a internet no atraviesa el servidor de máquinas virtuales.
\end_layout

\begin_layout Standard
Esta arquitectura, a pesar de ser sencilla, tiene un serio inconveniente:
 al aumentar el número de usuarios (y, por tanto, el número de servidores
 de máquinas virtuales) el 
\begin_inset Quotes eld
\end_inset

servidor principal
\begin_inset Quotes erd
\end_inset

 se convierte en un cuello de botella: no sólo debe atender un número de
 peticiones procedentes de la web cada vez mayor, sino que también debe
 procesar cada vez más tráfico procedente de los servidores de máquinas
 virtuales.
\end_layout

\begin_layout Standard
Este problema puede resolverse distribuyendo la funcionalidad de nuestro
 
\begin_inset Quotes eld
\end_inset

servidor principal
\begin_inset Quotes erd
\end_inset

 en dos máquinas: el 
\series bold
servidor de 
\emph on
cluster
\emph default
 
\series default
y el 
\series bold
servidor web
\series default
.
 Así, 
\end_layout

\begin_layout Itemize
cada usuario tendrá asignado un servidor de 
\emph on
cluster
\emph default
, al que se dirigirán todas sus peticiones.
\end_layout

\begin_layout Itemize
los servidores de 
\emph on
cluster
\emph default
 se encargarán exclusivamente de coordinar el funcionamiento de todos los
 servidores de máquinas virtuales que tienen asignados.
\end_layout

\begin_layout Itemize
el servidor web atenderá exclusivamente todas las peticiones que se reciban
 desde la web.
 Para ello, intercambiará datos con los servidores de 
\emph on
cluster
\emph default
 correspondientes.
\end_layout

\begin_layout Standard
La nueva alternativa tiene un serio inconveniente: el tráfico total que
 se genera es mayor, ya que hay que comunicar el servidor web con los distintos
 servidores de cluster.
 Pero su gran ventaja es la escalabilidad: añadiendo más servidores de máquinas
 virtuales y más servidores de 
\emph on
cluster 
\emph default
es posible atender a un número mucho mayor de alumnos.
\end_layout

\begin_layout Standard
Considerando el elevado número de estudiantes de la Universidad Complutense,
 nos pareció fundamental hacer 
\emph on
CygnusCloud
\emph default
 tan escalable como fuese posible, por lo que nos decantamos por el segundo
 modelo de arquitectura.
\end_layout

\begin_layout Subsubsection
Uso de la librería de red 
\emph on
twisted 
\begin_inset CommandInset label
LatexCommand label
name "sub:Uso-de-twisted"

\end_inset


\end_layout

\begin_layout Standard
Puesto que 
\emph on
CygnusCloud
\emph default
 se compone de sistemas diferentes que residen en máquinas distintas, es
 imprescindible comunicarlos.
 Puesto que las máquinas intercambian entre sí un gran volumen de datos,
 es muy conveniente utilizar un servicio orientado a conexión y fiable:
 TCP.
\end_layout

\begin_layout Standard
Para realizar las comunicaciones 
\emph on
socket 
\emph default
a 
\emph on
socket
\emph default
, optamos por utilizar la librería de red 
\emph on
twisted
\emph default
, que se basa en eventos y está íntegramente escrita en Python.
 Las razones que nos llevaron a elegirla fueron las siguientes:
\end_layout

\begin_layout Itemize

\emph on
twisted 
\emph default
es el estándar 
\emph on
de facto
\emph default
 para comunicar programas escritos en 
\emph on
Python
\emph default
 sin necesidad de manipular 
\emph on
sockets
\emph default
 directamente, y forma parte de la instalación predeterminada de la mayoría
 de distribuciones 
\emph on
GNU/Linux
\emph default
 (e incluso de 
\emph on
Mac OS X
\emph default
).
\end_layout

\begin_layout Itemize
existen libros, una ingente cantidad de documentación, foros y tutoriales
 con abundantes explicaciones de uso.
\end_layout

\begin_layout Itemize
se trata de una librería de código abierto, distribuida bajo licencia MIT
 y actualizada periódicamente.
\end_layout

\begin_layout Itemize
proporciona toda la funcionalidad que hemos utilizado a lo largo del desarrollo
 del proyecto.
\end_layout

\begin_layout Standard
El gran inconveniente de esta librería es su propia documentación.
 Debido a su enorme extensión, hay partes desactualizadas, partes que contradice
n a otras, partes sin apenas documentar\SpecialChar \ldots{}
 por lo que en la práctica su uso
 requiere seguir el método de prueba y error.
\end_layout

\begin_layout Standard
No obstante, tal y como expusimos en la sección 
\begin_inset CommandInset ref
LatexCommand ref
reference "sub:Restricciones-arquitectura"

\end_inset

, para facilitar la portabilidad entre distribuciones 
\emph on
GNU/Linux 
\emph default
es imprescindible utilizar mecanismos estandarizados, por lo que nos acabamos
 decantando por utilizar esta librería.
\end_layout

\begin_layout Subsubsection
Cifrado selectivo del tráfico
\end_layout

\begin_layout Standard
El tráfico que genera el sistema 
\emph on
CygnusCloud
\emph default
 puede clasificarse en dos grupos:
\end_layout

\begin_layout Itemize
tráfico generado por el protocolo de escritorio remoto VNC.
 Se trata del tráfico mayoritario, y permite a los usuarios manipular sus
 máquinas virtuales utilizando las interfaces gráficas a las que están acostumbr
ados.
\end_layout

\begin_layout Itemize
tráfico generado por los protocolos de 
\emph on
CygnusCloud
\emph default
.
 Este tráfico es minoritario, y se genera al procesar peticiones como la
 instanciación y destrucción de máquinas virtuales, la recopilación de estadísti
cas dentro de los distintos 
\emph on
clusters
\emph default
, \SpecialChar \ldots{}

\end_layout

\begin_layout Standard
Considerando que la red de la UCM es ya de por sí segura, no sería necesario
 cifrar el tráfico.
 No obstante, para garantizar el correcto funcionamiento del sistema 
\emph on
CygnusCloud
\emph default
, todas las comunicaciones salvo las conexiones a escritorio remoto están
 protegidas mediante cifrado SSL.
 Esto nos permite:
\end_layout

\begin_layout Itemize
ahorrar ancho de banda.
 Como el tráfico mayoritario está sin cifrar, es posible utilizar el ancho
 de banda para soportar más conexiones a escritorio remoto (y, por tanto,
 dar servicio a un mayor número de usuarios).
\end_layout

\begin_layout Itemize
monitorizar fácilmente las actividades que realizan los usuarios en sus
 máquinas virtuales.
\end_layout

\begin_layout Itemize
aumentar la robustez del sistema frente a ataques desde la propia red de
 la UCM.
 Gracias al cifrado de los datos generados por los protocolos, lo único
 que un atacante puede controlar con facilidad es una única máquina virtual,
 pero no la infraestructura de 
\emph on
CygnusCloud
\emph default
.
\end_layout

\begin_layout Subsubsection
Uso del 
\emph on
framework
\emph default
 
\emph on
web2py
\begin_inset CommandInset label
LatexCommand label
name "sub:Uso-web2py"

\end_inset


\end_layout

\begin_layout Standard
Web2py es una plataforma web de código abierto (licencia GPL versión 2)
 que permite un ágil desarrollo de aplicaciones web seguras, gestionadas
 por medio de bases de datos.
 Esta escrito y es programable en python y contiene todos los componentes
 necesarios para construir aplicaciones completamente funcionales.
\end_layout

\begin_layout Standard
Al ser un framework web, web2py ofrece un rígido diseño de cara a la seguridad.
 Así, es capaz de resolver ciertas vulnerabilidades de forma automática
 siguiendo unas prácticas bien establecidas.
 Por ejemplo, web2py gestiona automáticamente el formateo de las entradas
 y salidas, aplica acciones de encriptado en los ficheros subidos y controla
 el área de maniobra de los desarrolladores de cara a la seguridad del sistema.
\end_layout

\begin_layout Standard
Además web2py ofrece una capa de abstracción de base de datos (DAL por su
 acrónimo inglés), que genera código SQL de forma transparente al modelo
 de gestión de datos utilizado (SQLite, MySQL, PostgreSQL, Oracle ...).
\end_layout

\begin_layout Paragraph*
Modelo Vista-Controlador
\end_layout

\begin_layout Standard
Web2py fuerza al desarrollador a utilizar unas buenas prácticas de ingeniería
 del software, evitando la repetición de código en la medida de lo posible
 y estandarizando la manera de hacer las cosas.
 
\end_layout

\begin_layout Standard
Por ello, este framework utiliza un modelo Vista-Controlador que incentiva
 al desarrollador a separar la forma de representar los datos (la vista)
 y el flujo de trabajo de la aplicación (el controlador).
 Este modelo ofrece una estructura modular que permite aislar los posibles
 errores en una sección de código concreta y trabajar en paralelo de forma
 independiente, reduciendo así los posibles tiempos de espera en el desarrollo
 de la web.
\end_layout

\begin_layout Standard
El flujo de trabajo típico de una petición web2py viene representado en
 el diagrama 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Diagram-web2py"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/DiagramaSecuenciaWeb2py.png
	scale 50
	rotateOrigin center

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Diagram-web2py"

\end_inset

Diagrama de secuencia web2py
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
En el diagrama podemos destacar los siguientes elementos:
\end_layout

\begin_layout Itemize
El navegador, a partir del cual el usuario se conectará a la web.
\end_layout

\begin_layout Itemize
El servidor, puede ser el servidor incluido en web2py o un servidor de terceros,
 tal como Apache.
\end_layout

\begin_layout Itemize
La aplicación principal, encargada de realizar todas las tareas comunes
 tal y como la gestión de cookies, sesiones, transacciones y enrutamiento.
\end_layout

\begin_layout Itemize
Los modelos, vistas y controladores que componen la aplicación del desarrollador.
\end_layout

\begin_layout Itemize
La Base de datos que se encargará de almacenar la información utilizada
 por la web.
\end_layout

\begin_layout Standard
Todas las llamadas se encierran en una transacción.
 Cualquier excepción no contemplada hace que la transacción se cancele.
 
\end_layout

\begin_layout Standard
Con web2py es posible registrar tareas recurrentes para ejecutarse en horas
 específicas y/o después de determinadas acciones.
 También es posible alojar varias aplicaciones en una misma instancia.
 
\begin_inset CommandInset citation
LatexCommand cite
key "Web2PyBook"

\end_inset


\end_layout

\begin_layout Paragraph*
Ventajas
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Esto no se si irá aquí o se meterá en otro apartado
\end_layout

\begin_layout Plain Layout
INICIO
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Las principales razones por las cuales hemos decidido utilizar web2py frente
 a otros frameworks web basados en python tales como Django o Grok son:
\end_layout

\begin_layout Itemize
Ofrece una estructura sencilla que permite a los usuarios aprender sobre
 el desarrollo web sin comprometer la funcionalidad del sistema.
 Por esta razón, web2py no requiere instalación ni configuración, no tiene
 dependencias, y expone la mayor parte de su funcionalidad a través de una
 interfaz de navegador web.
\end_layout

\begin_layout Itemize
Se ha mantenido estable desde el primer día, ofreciendo un diseño de arriba
 a abajo que asegura una total compatibilidad con respecto a aplicaciones
 que fueron realizadas utilizando versiones anteriores.
\end_layout

\begin_layout Itemize
Ataca de manera pro activa las cuestiones de seguridad más relevantes en
 las aplicaciones web modernas.
\end_layout

\begin_layout Itemize
Ofrece interfaces administrativas para simplificar la creación y gestión
 de las bases de datos (appAdmin) y la interacción de las diferentes vistas
 y controladores.
\end_layout

\begin_layout Itemize
Es ligero.
 Todas las librerías y código necesario para desarrollar aplicaciones ocupa
 en torno a 2 MB.
\end_layout

\begin_layout Itemize
Es rápido, ofreciendo una velocidad un 30% superior que un servidor Apache
 medio.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
FIN
\end_layout

\end_inset


\end_layout

\begin_layout Paragraph*
Seguridad
\end_layout

\begin_layout Standard
Con respecto a la seguridad, web2py se centra en resolver los 10 principales
 problemas de seguridad definidos por OWASP (Proyecto de Seguridad de Aplicacion
es Web Abiertas), una comunidad mundial libre enfocada en la mejora de la
 seguridad de aplicaciones de software
\begin_inset CommandInset citation
LatexCommand cite
key "OWASP"

\end_inset

.
\end_layout

\begin_layout Standard
En términos generales, estos 10 problemas son:
\end_layout

\begin_layout Itemize
Cross Site Scripting (XSS)
\end_layout

\begin_layout Itemize
inyecciones SQL
\end_layout

\begin_layout Itemize
Ejecución de archivos maliciosos
\end_layout

\begin_layout Itemize
Referencia directa a objetos
\end_layout

\begin_layout Itemize
Cross Site Request Forgery (CSRF)
\end_layout

\begin_layout Itemize
Fugas de información y manejo de errores inapropiado
\end_layout

\begin_layout Itemize
Administración de sesiones y autentificación rota
\end_layout

\begin_layout Itemize
Almacenamiento criptográfico inseguro
\end_layout

\begin_layout Itemize
Comunicaciones inseguras
\end_layout

\begin_layout Itemize
Restricciones de acceso URL
\end_layout

\begin_layout Subsection
El paquete 
\family typewriter
database
\end_layout

\begin_layout Subsection
El paquete 
\family typewriter
network
\end_layout

\begin_layout Standard
Los módulos de este paquete proporcionan una interfaz que permite utilizar
 la librería de red 
\emph on
twisted
\emph default
 a un alto nivel de abstracción.
 Puesto que el diseño de esta parte del sistema está íntimamente relacionado
 con el funcionamiento de la librería de red 
\emph on
twisted
\emph default
, es fundamental que el lector esté familiarizado con los conceptos básicos
 de esta librería.
\end_layout

\begin_layout Standard
Por ello, comenzaremos mostrando, en líneas generales, cómo funciona la
 librería de red 
\emph on
twisted
\emph default
.
 Posteriormente, describiremos el contenido de este paquete en orden creciente
 del nivel de abstracción, profundizando más en el funcionamiento de 
\emph on
twisted
\emph default
 cuando sea preciso.
\end_layout

\begin_layout Standard
En cualquier caso, dado que 
\emph on
twisted
\emph default
 es una librería con muchas funciones, nos centraremos en mostrar su funcionamie
nto más general.
 Si el lector está interesado en ampliar la información que aquí le proporcionam
os, le remitimos a la documentación oficial (
\begin_inset CommandInset citation
LatexCommand cite
key "TwistedCoreDocs"

\end_inset

) y al libro 
\emph on
Twisted Network Programming Essentials
\emph default
 (
\begin_inset CommandInset citation
LatexCommand cite
key "TwistedBook"

\end_inset

).
\end_layout

\begin_layout Subsubsection
La librería de red 
\emph on
twisted
\emph default
: visión general
\emph on
 
\begin_inset CommandInset label
LatexCommand label
name "sub:La-librería-de-red-twisted"

\end_inset


\end_layout

\begin_layout Standard
Tal y como adelantamos en la sección 
\begin_inset CommandInset ref
LatexCommand ref
reference "sub:Uso-de-twisted"

\end_inset

, 
\emph on
twisted
\emph default
 es una librería de red totalmente basada en eventos.
 Así, todas las tareas que realiza (como la recepción de datos, el establecimien
to de conexiones, la detección de desconexiones,\SpecialChar \ldots{}
) son totalmente asíncronas.
\end_layout

\begin_layout Standard
Para generar los eventos, 
\emph on
twisted
\emph default
 utiliza el patrón 
\emph on
reactor
\emph default
, es decir, muestrea periódicamente el estado de los 
\emph on
sockets
\emph default
 y actúa en consecuencia.
 De esta manera, todas las aplicaciones que utilizen 
\emph on
twisted
\emph default
 seguirán el siguiente esquema de comportamiento:
\end_layout

\begin_layout Enumerate
el código de la librería muestrea los 
\emph on
sockets
\emph default
 abiertos por la aplicación para detectar cambios.
 
\end_layout

\begin_layout Enumerate
cuando se detecta un cambio, se genera un evento para informar del cambio
 al código del cliente.
\end_layout

\begin_layout Enumerate
el código del cliente utiliza la información asociada al evento y procesa
 el cambio.
\end_layout

\begin_layout Enumerate
cuando termina, el código del cliente devuelve el control al código de la
 librería.
\end_layout

\begin_layout Standard
El muestreo de los 
\emph on
sockets
\emph default
 y el tratamiento de los cambios tiene lugar en un bucle que se ejecuta
 permanentemente: el 
\emph on
bucle reactor
\emph default
.
 La figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:El-bucle-reactor"

\end_inset

 resume de forma gráfica las ideas que acabamos de exponer.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/gráfico_twisted.pdf
	scale 70

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:El-bucle-reactor"

\end_inset

Representación gráfica del funcionamiento de la librería 
\emph on
twisted
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Paragraph
Protocolos y factorías de protocolos
\end_layout

\begin_layout Standard
La forma en que se procesan los datos recibidos a través de la red varía
 de unas aplicaciones a otras, e incluso puede variar en una misma aplicación.
 Por ejemplo, en 
\emph on
CygnusCloud
\emph default
 algunos datos recibidos se escriben en una base de datos, otros se reenvían
 y otros se le muestran directamente al usuario.
 Por ello, es necesario que el proceso de generación y tratamiento del evento
 no dependa de los datos concretos que manipula cada aplicación.
 Para hacer esto posible, 
\emph on
twisted
\emph default
 define los 
\emph on
protocolos
\emph default
 y las 
\emph on
factorías de protocolos
\emph default
.
\end_layout

\begin_layout Standard
Un 
\emph on
protocolo
\emph default
 es una clase cuyos métodos tratan y generan eventos de red, tales como
 la recepción de un segmento TCP, el envío de un segmento TCP y la detección
 de desconexión.
 Por su parte, las 
\emph on
factorías de protocolos
\emph default
 son objetos capaces de instanciar y configurar protocolos.
 Los protocolos y las factorías de protocolos se manipulan siempre a través
 de dos interfaces, que se definen en las clases abstractas 
\family typewriter
Protocol
\family default
 y 
\family typewriter
Factory
\family default
 respectivamente.
 
\end_layout

\begin_layout Paragraph
El bucle reactor
\end_layout

\begin_layout Standard
Su misión principal es muestrear periódicamente todos los 
\emph on
sockets
\emph default
 abiertos e invocar a las rutinas de tratamiento adecuados cuando se produzca
 un evento.
 Como ya hemos dicho, las rutinas de tratamiento se definen en instancias
 de subclases concretas de 
\family typewriter
Protocol
\family default
.
\end_layout

\begin_layout Standard
En la librería 
\emph on
twisted
\emph default
 se definen varios bucles reactor, que se diferencian fundamentalmente por
 la forma de realizar el muestreo periódico.
 Nosotros utilizamos el que está definido en la clase 
\family typewriter
PollReactor
\family default
, que se limita a leer periódicamente todos los 
\emph on
sockets
\emph default
 para determinar si se han producido cambios.
 
\end_layout

\begin_layout Standard
Para que el funcionamiento de la librería sea el correcto, deben cumplirse
 dos restricciones:
\end_layout

\begin_layout Itemize
aunque en cada aplicación puede haber un número arbitrario de conexiones
 activas, sólo puede existir 
\emph on
un
\emph default
 único bucle reactor.
 
\end_layout

\begin_layout Itemize
una vez que se detiene el bucle reactor, este 
\emph on
no
\emph default
 puede reiniciarse mientras la aplicación se siga ejecutando.
 Por ello, sólo se puede salir de este bucle cuando la aplicación no va
 a utilizar más la red.
\end_layout

\begin_layout Standard
Por otra parte, los eventos de red se tratan en el propio bucle del reactor.
 Para garantizar un tiempo de respuesta adecuado, es imprescindible que
 los métodos de tratamiento sean tan rápidos como sea posible.
 
\end_layout

\begin_layout Paragraph
Procesamiento de datos entrantes
\end_layout

\begin_layout Standard
El diagrama de secuencia de la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Procesamiento-de-datos-entrantes-twisted"

\end_inset

 muestra cómo se procesan los eventos asociados a dos conexiones, cuyos
 protocolos son instancias de las subclases de 
\family typewriter
Protocol Protocol1
\family default
 y 
\family typewriter
Protocol2
\family default
.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/Procesamiento de datos entrantes (DS).pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Procesamiento-de-datos-entrantes-twisted"

\end_inset

Procesamiento de datos entrantes en 
\emph on
twisted
\emph default
: diagrama de secuencia
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
En ambos casos, se muestrea el 
\emph on
socket
\emph default
, para posteriormente invocar al método correspondiente del protocolo: el
 método de procesamiento de los datos entrantes en el primer caso, y el
 método de procesamiento de una desconexión en el segundo.
\end_layout

\begin_layout Paragraph
Establecimiento de conexiones
\end_layout

\begin_layout Standard
Para establecer una conexión, es necesario tener en cuenta
\end_layout

\begin_layout Itemize
el protocolo de transporte que hay que utilizar (TCP versión 4, SSL,\SpecialChar \ldots{}
), y
\end_layout

\begin_layout Itemize
el papel que desempeña la máquina en la conexión (cliente o servidor).
\end_layout

\begin_layout Standard
Para eliminar en la medida de lo posible los detalles de bajo nivel de nuestro
 código, hemos utilizado una función que se ha añadido recientemente a la
 librería 
\emph on
twisted
\emph default
: los 
\emph on
endpoints
\emph default
.
\end_layout

\begin_layout Standard
Un 
\emph on
endpoint
\emph default
 sirve para configurar uno de los extremos de la conexión.
 Todos los protocolos de transporte implementados en 
\emph on
twisted 
\emph default
definen dos: uno para la máquina servidor y otro para las máquinas cliente.
 En el proceso de conexión, el 
\emph on
endpoint
\emph default
, que es una instancia de una subclase concreta de 
\family typewriter
Endpoint
\family default
, 
\end_layout

\begin_layout Itemize
interactúa con el reactor para establecer la conexión.
\end_layout

\begin_layout Itemize
suministra al reactor la factoría de protocolos.
 Este la utilizará para instanciar protocolos cuando sea necesario.
\end_layout

\begin_layout Standard
Las relaciones existentes entre la clase 
\family typewriter
Endpoint
\family default
 y el resto de clases principales de la librería 
\emph on
twisted
\emph default
 aparecen en el diagrama de clases de la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Relaciones-protocolos-endpoints-factorías"

\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/Relaciones Endpoints.pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Relaciones-protocolos-endpoints-factorías"

\end_inset

Relaciones entre protocolos, factorías de protocolos y 
\emph on
endpoints
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Todos los 
\emph on
endpoints
\emph default
 son instancias de alguna subclase concreta la clase 
\family typewriter
Endpoint
\family default
.
 En el diagrama sólo aparecen las subclases de 
\emph on
endpoint
\emph default
 que utilizamos en el paquete 
\family typewriter
network
\family default
, correspondientes a los protocolos TCP versión 4 y SSL versión 4.
 Por otra parte, los 
\emph on
endpoints
\emph default
 no manipulan directamente un PollReactor: para ello, utilizan las interfaces
 que esta clase implementa.
 Nos hemos tomado esta licencia para simplificar la explicación.
\end_layout

\begin_layout Standard
Como ya hemos visto, los protocolos se crean al establecerse la conexión.
 Además, puesto que siempre están ligados a una conexión, estos objetos
 se destruyen cuando esta se cierra.
\end_layout

\begin_layout Standard
Por otra parte, el diagrama de secuencia de la figura muestra la interacción
 que tiene lugar al establecer dos conexiones TCP, una de tipo servidor
 y otra de tipo cliente.
 En ambos casos, los 
\emph on
endpoints
\emph default
 se limitan, en esencia, a solicitar al reactor al establecimiento de la
 conexión y a suministrarle la factoría de protocolos que debe utilizar.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/Establecimiento conexión twisted (DS).pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Establecimiento-conexión-twisted"

\end_inset

Establecimiento de una conexión en 
\emph on
twisted
\emph default
: diagrama de secuencia
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Finalmente, los protocolos se usan de forma distinta en función del tipo
 de conexión:
\end_layout

\begin_layout Itemize
en el caso de una conexión de tipo cliente, existirá un único protocolo,
 que permitirá la comunicación bidireccional con el servidor.
\end_layout

\begin_layout Itemize
en el caso de una conexión de tipo servidor, existirán tantos protocolos
 como clientes.
 Cada uno de ellos permitirá la comunicación bidireccional entre el servidor
 y un único cliente.
\end_layout

\begin_layout Paragraph
Envío de datos
\end_layout

\begin_layout Standard
Tal y como hemos mencionado, para enviar datos a través de la red se utilizan
 instancias de subclases concretas de 
\family typewriter
Protocol
\family default
.
 El reactor nunca interviene a la hora de enviar datos: los 
\emph on
bytes
\emph default
 a enviar se escriben directamente en el 
\emph on
socket
\emph default
 correspondiente.
\end_layout

\begin_layout Standard
En principio, la única restricción que impone librería 
\emph on
twisted
\emph default
 es el tipo de los datos a enviar: sólo es posible enviar 
\emph on
strings
\emph default
 (es decir, secuencias de 
\emph on
bytes
\emph default
), lo que hace necesario serializar toda la información antes de enviarla
 y deserializarla al recibirla.
 
\end_layout

\begin_layout Standard
Es importante notar que el número de 
\emph on
bytes
\emph default
 a enviar no está limitado.
 Por tanto, los segmentos se fragmentarán cuando sea preciso.
\end_layout

\begin_layout Subsubsection
La clase 
\family typewriter
Packet
\end_layout

\begin_layout Standard
Para utilizar la librería de red 
\emph on
twisted
\emph default
 a un mayor nivel de abstracción, es imprescindible hacer transparente al
 usuario la serialización y la deserialización de la información que circula
 a través de la red.
 Esta es la principal finalidad de la clase 
\family typewriter
Packet
\family default
.
\end_layout

\begin_layout Standard
Por otra parte, no toda la información que circula por la red tiene la misma
 naturaleza o la misma importancia.
 Por ello, los paquetes también tienen asociado un tipo y una prioridad.
 Los valores que pueden tomar estos dos campos aparecen en el cuadro 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:Tipos-prioridades-paquetes"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="3" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Tipo de paquete
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Rango de la prioridad
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
¿Se usa en el código del cliente?
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Datos del cliente
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $[0,\infty]$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Sí
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Gestión de la red
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $[-\infty,-1]$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
No
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:Tipos-prioridades-paquetes"

\end_inset

Tipos de paquetes y sus prioridades
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
La prioridad de los paquetes es un valor entero, que toma valores positivos
 en el caso de los paquetes que utilizan los usuarios y valores negativos
 en el caso de los paquetes de gestión de la red.
 Cuanto menor sea el valor numérico que toma la prioridad de un paquete,
 más prioritario será.
 Nótese que los rangos de prioridad están escogidos de modo que los paquetes
 de gestión de la red siempre son más prioritarios que los paquetes que
 transportan los datos del cliente.
\end_layout

\begin_layout Standard
El tipo de paquete y su prioridad se almacenan en el encabezado del paquete.
 Para garantizar que siempre está bien construido (lo que es crítico para
 garantizar el correcto funcionamiento de la red), no se permite a los clientes
 instanciar objetos 
\family typewriter
Packet
\family default
 directamente.
\end_layout

\begin_layout Standard
Para serializar los datos, la clase 
\family typewriter
Packet
\family default
 dispone de métodos de escritura que serializan 
\emph on
strings
\emph default
, valores enteros, valores booleanos y números en punto flotante.
 Los datos serializados se almacenaran en una estructura de datos intermedia,
 que se leerá a la hora de enviar el paquete para obtener la información
 serializada que hay que enviar.
\end_layout

\begin_layout Standard
El formato de un paquete serializado es el siguiente:
\end_layout

\begin_layout Standard
\noindent
\align center

\family typewriter
_Packet(tipo, prioridad)<datos>
\end_layout

\begin_layout Standard
La cadena 
\family typewriter
datos
\family default
 se construye de acuerdo a la siguiente expresión regular:
\end_layout

\begin_layout Standard
\noindent
\align center

\family typewriter
(etiqueta de tipo$valor$)*
\end_layout

\begin_layout Standard
Los códigos asignados a los tipos de paquete aparecen en el cuadro 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:Códigos-asignados-tipos-paquete"

\end_inset

, y las etiquetas de tipo que pueden utilizarse aparecen en el cuadro 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:Etiquetas-de-tipo-paquete"

\end_inset

.
 Para serializar los valores y la prioridad, se hace uso de los métodos
 de conversión a 
\emph on
string
\emph default
 del lenguaje Python.
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Float table
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="3" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Código
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Tipo de paquete
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Datos del cliente
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Gestión de la red
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:Códigos-asignados-tipos-paquete"

\end_inset

Códigos asignados a los tipos de paquete
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Float table
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Etiqueta
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Tipo de datos
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
entero
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
entero largo
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\emph on
string
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
número de punto flotante
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:Etiquetas-de-tipo-paquete"

\end_inset

Etiquetas de tipo que pueden aparecer en un paquete
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Por otro lado, la deserialización de los datos se realiza siempre bajo demanda
 del cliente y en forma de lectura destructiva: cuando el cliente lee un
 valor, se eliminan sus bytes de la estructura de datos intermedia y se
 devuelve el valor leído.
\end_layout

\begin_layout Standard
Finalmente, en caso de que una operación de la clase 
\family typewriter
Packet
\family default
 falle, se lanzará una excepción de la clase 
\family typewriter
PacketException
\family default
 conteniendo el correspondiente mensaje de error.
\end_layout

\begin_layout Subsubsection
Envío y recepción de datos
\end_layout

\begin_layout Standard
Para enviar y recibir datos mediante la librería 
\emph on
twisted
\emph default
 utilizamos dos clases: una subclase de 
\family typewriter
Protocol
\family default
 (
\family typewriter
CygnusCloudProtocol
\family default
) y una subclase de
\family typewriter
 Factory
\family default
 (
\family typewriter
CygnusCloudProtocolFactory
\family default
).
 Las relaciones de estas clases con las demás aparecen en el diagrama de
 clases de la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Interacción-twisted-diagrama-clases"

\end_inset

.
 En dicho diagrama, hemos abreviado 
\family typewriter
CygnusCloud
\family default
 como 
\family typewriter
CC
\family default
.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Interacción-twisted-diagrama-clases"

\end_inset

Interacción con la librería
\emph on
 twisted
\emph default
: diagrama de clases
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
La relación entre las clases 
\family typewriter
CygnusCloudProtocol
\family default
 y 
\family typewriter
CygnusCloudProtocolFactory
\family default
 es más compleja de lo que en principio cabría esperar.
 Tal y como dijimos en la sección 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Interacción-twisted-diagrama-clases"

\end_inset

, hay 
\emph on
una
\emph default
 instancia de 
\family typewriter
Protocol
\family default
 en cada extremo de la comunicación.
 Esto genera un problema: como las conexiones no tienen por qué ser bidirecciona
les, en un extremo de la conexión puede haber 
\emph on
varios
\emph default
 objetos 
\family typewriter
Protocol
\family default
.
 Por ejemplo, si siete clientes se conectan a un servidor, en dicho servidor
 habrá siete objetos 
\family typewriter
Protocol
\family default
 asociados a esa conexión: uno para cada cliente.
\end_layout

\begin_layout Standard
Para resolver este problema, la clase 
\family typewriter
CygnusCloudProtocolFactory
\family default
 define los métodos de envío de paquetes, de modo que estos se enviarán
 a través de todos los objetos 
\family typewriter
Protocol
\family default
 asociados a la conexión.
 Asimismo, la clase 
\family typewriter
CygnusCloudProtocolFactory
\family default
 tratará las notificaciones de conexión y desconexión que la librería 
\emph on
twisted
\emph default
 envía a través de los objetos 
\family typewriter
Protocol
\family default
.
\end_layout

\begin_layout Standard
La recepción de paquetes es mucho más sencilla: cuando se reciben datos
 a través de cualquier objeto Protocol, se añaden a una cola de paquetes
 recibidos (que es una instancia de 
\family typewriter
MultithreadingPriorityQueue
\family default
).
 Como veremos más adelante, en principio cada conexión dispone de su propia
 cola de recepción de paquetes.
\end_layout

\begin_layout Standard
Por otra parte, como ya hemos dicho la librería de red 
\emph on
twisted
\emph default
 sólo puede enviar 
\emph on
strings
\emph default
 y recibir 
\emph on
strings
\emph default
.
 Para serializar los datos antes de enviarlos y deserializarlos tras recibirlos,
 los objetos 
\family typewriter
CygnusCloudProtocol
\family default
 manipulan objetos 
\family typewriter
Packet
\family default
, que también se utilizan en el código del cliente para enviar y recibir
 información.
\end_layout

\begin_layout Standard
Finalmente, en el diagrama de la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Interacción-twisted-diagrama-clases"

\end_inset

 también aparecen las subclases de 
\family typewriter
Endpoint
\family default
 que se utilizan en el paquete 
\family typewriter
network
\family default
.
 Siempre que se crea una conexión de red, se instancia una subclase de 
\family typewriter
Endpoint
\family default
 distinta en función del protocolo escogido (TCP versión 4 o SSL versión
 4) y del papel que desempeñará la máquina en la conexión (servidor o cliente).
\end_layout

\begin_layout Subsubsection
Hilos de red 
\begin_inset CommandInset label
LatexCommand label
name "sub:Hilos-de-red"

\end_inset


\end_layout

\begin_layout Standard
Cuando en la sección 
\begin_inset CommandInset ref
LatexCommand ref
reference "sub:La-librería-de-red-twisted"

\end_inset

 presentamos el funcionamiento de la librería de red 
\emph on
twisted
\emph default
 mencionamos que, por tratarse de una librería de red basada en eventos,
 el procesamiento de los datos recibidos en el bucle del reactor debe ser
 tan rápido como sea posible.
\end_layout

\begin_layout Standard

\emph on
CygnusCloud
\emph default
 está formado por subsistemas con características y tiempos de respuesta
 muy diferentes, por lo que es imprescindible garantizar que la red funcionará
 lo suficientemente rápido en todos ellos.
 Para ello, la mejor alternativa es utilizar varios hilos.
\end_layout

\begin_layout Standard
El diagrama de clases de la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Jerarquía-de-hilos-red"

\end_inset

 muestra las clases de hilos que se utilizan en el paquete
\emph on
 
\family typewriter
\emph default
network
\family default
\emph on
 
\emph default
y sus relaciones.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/DiagramaClasesJerarquíaHilosRed.pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Jerarquía-de-hilos-red"

\end_inset

Jerarquía de hilos de red
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
Esencialmente, los hilos de la clase 
\family typewriter
BasicThread
\family default
 se detienen cuando otros se lo solicitan, y los hilos de la clase 
\family typewriter
QueueProcessingThread
\family default
 procesan los elementos de una cola.
 Dependiendo de su naturaleza, los hilos del paquete 
\family typewriter
network.threads
\family default
 heredan de una clase o de otra.
 
\end_layout

\begin_layout Standard
Las instancias de 
\family typewriter
TwistedReactorThread
\family default
 ejecutan, como su nombre indica, el bucle del reactor de la libreria 
\emph on
twisted
\emph default
.
 
\end_layout

\begin_layout Standard
Por otra parte, los hilos 
\family typewriter
ConnectionMonitoringThread
\family default
 actualizan periódicamente el estado de las conexiones.
 Esto es fundamental para determinar, entre otras cosas, cuándo una conexión
 puede empezar a utilizarse, cuándo se producen desconexiones,\SpecialChar \ldots{}

\end_layout

\begin_layout Standard
Finalmente, para manipular los paquetes entrantes y los paquetes salientes
 se utilizan los hilos 
\family typewriter
IncomingDataThread
\family default
 y 
\family typewriter
OutgoingDataThread
\family default
.
 Para indicar al código del cliente que se ha recibido un nuevo paquete,
 se hace uso de la interfaz que define la clase 
\family typewriter
NetworkCallback
\family default
.
 
\end_layout

\begin_layout Standard
Es importante notar que todo el procesamiento de los paquetes entrantes
 tendrá lugar en un hilo 
\family typewriter
IncomingDataThread
\family default
 y no en el hilo del bucle reactor de 
\emph on
twisted
\emph default
, lo que nos permite garantizar que el tiempo de respuesta de la red será
 adecuado independientemente del tiempo que tarde en procesarse el paquete.
\end_layout

\begin_layout Subsubsection
La clase 
\family typewriter
NetworkConnection
\end_layout

\begin_layout Standard
Como el lector habrá notado ya, una conexión de red tiene muchos recursos
 asociados:
\end_layout

\begin_layout Itemize
su estado
\end_layout

\begin_layout Itemize
una cola para almacenar los paquetes recibidos y otra cola para almacenar
 los paquetes a enviar
\end_layout

\begin_layout Itemize
una factoría, es decir, una instancia de 
\family typewriter
CygnusCloudProtocolFactory
\family default
, que se utiliza para enviar y recibir paquetes.
\end_layout

\begin_layout Itemize
un hilo que procesa los paquetes recibidos y otro que envía los paquetes
\end_layout

\begin_layout Itemize
una dirección IP y un puerto, junto con el protocolo a utilizar (TCP versión
 4 o SSL versión 4).
\end_layout

\begin_layout Standard
Puesto que todos ellos están fuertemente relacionados, lo más conveniente
 es manipularlos de forma conjunta.
 Esta es la finalidad de la clase 
\family typewriter
NetworkConnection
\family default
.
 
\end_layout

\begin_layout Paragraph
Estado de la conexión
\end_layout

\begin_layout Standard
El estado de una conexión evoluciona de acuerdo al diagrama de la figura
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Diagrama-de-estados-conexión"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/Diagrama estados conexión.pdf
	scale 85

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Diagrama-de-estados-conexión"

\end_inset

Diagrama de estados de una conexión
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
Puesto que no tiene sentido enviar datos desde un servidor cuando todavía
 no hay clientes conectados, cuando una conexión de servidor se encuentra
 en el estado 
\family sans
Conexión lista, no hay clientes conectados 
\family default
no se puede utilizar.
 Por ello, si el código del cliente la cierra, esta pasará directamente
 al estado 
\family sans
Conexión cerrada
\family default
, ya que no hay paquetes recibidos por procesar ni paquetes pendientes de
 enviar.
\end_layout

\begin_layout Standard
Las conexiones sólo puede utilizarse para enviar y recibir datos en el estado
 
\family sans
Conexión lista
\family default
.
 Lo habitual es que la conexión permanezca en este estado mientras se está
 utilizando.
\end_layout

\begin_layout Standard
Cuando una conexión se cierra normalmente, se envían los paquetes pendientes
 a su través y, posteriormente, se cierra.
 Esta es la finalidad del estado 
\family sans
Conexión cerrandose
\family default
.
 Por otra parte, si una conexión se cierra de forma inesperada no se podrá
 volver a utilizar.
 Por ello, en estos casos se pasa directamente al estado 
\family sans
Conexión cerrada
\family default
: no es posible enviar ni recibir ningún tipo de paquete.
\end_layout

\begin_layout Paragraph
Control de la concurrencia
\end_layout

\begin_layout Standard
En principio, cada conexión de red tiene asociados un hilo de envío de paquetes
 y un hilo de recepción de paquetes.
 Así,
\end_layout

\begin_layout Itemize
el tiempo que tardan los paquetes en procesarse no afecta al tiempo de respuesta
 de la red, y
\end_layout

\begin_layout Itemize
el código del cliente no debe bloquearse hasta que se envían sus paquetes.
\end_layout

\begin_layout Standard
No obstante, el número de CPUs de los computadores es siempre limitado.
 Y teniendo en cuenta que una misma máquina puede tener más de una conexión
 con otras, es fundamental proporcionar mecanismos que permitan acotar el
 número de hilos que utiliza la red.
\end_layout

\begin_layout Standard
En primer lugar, centrémonos en el hilo de envío de paquetes.
 Por muchas conexiones que haya, todos sus paquetes deberán enviarse a través
 de la misma interfaz de red.
 Por ello, estos datos se transferirán de forma multiplexada, con independencia
 del número de hilos que haya.
\end_layout

\begin_layout Standard
Si bien esto es totalmente transparente al usuario gracias al uso de la
 librería de red 
\emph on
twisted
\emph default
, también es cierto que este comportamiento no es óptimo en todas las situacione
s.
 Por ejemplo, si a través de tres conexiones deben enviarse los siguientes
 paquetes:
\end_layout

\begin_layout Itemize

\series bold
conexión 1
\series default
: un paquete de gestión de la red, tres paquetes con datos del cliente
\end_layout

\begin_layout Itemize

\series bold
conexión 2
\series default
: tres paquetes de gestión de la red
\end_layout

\begin_layout Itemize

\series bold
conexión 3
\series default
: tres paquetes con datos del cliente
\end_layout

\begin_layout Standard
es posible que los paquetes de datos de la conexión 3 se envíen antes que
 los paquetes de gestión de la red de la conexión 2, lo cual no es nada
 deseable: los paquetes de gestión de la red son más prioritarios.
 
\end_layout

\begin_layout Standard
Este problema se resuelve de forma muy simple: si sólo hay una cola de paquetes
 salientes (y, por tanto, un único hilo de envío de paquetes), los paquetes
 más prioritarios se enviarán antes que los menos prioritarios.
 Además, esta solución también nos permite reducir el número de hilos activos:
 en cada máquina, sólo habrá un único hilo de envío de paquetes.
 
\end_layout

\begin_layout Standard
Por otra parte, los hilos de recepción de paquetes no pueden fusionarse
 de forma tan sencilla, ya que los módulos que procesan los paquetes recibidos
 desde cada conexión pueden ser totalmente diferentes.
\end_layout

\begin_layout Standard
La solución en este caso pasa por el propio objeto que procesa los paquetes
 recibidos: una instancia de 
\family sans
NetworkCallback
\family default
.
 En caso de que un mismo objeto 
\family sans
NetworkCallback
\family default
 esté procesando los paquetes recibidos a través de varias conexiones, podemos
 utilizar de forma segura un único hilo de recepción de paquetes (y, por
 tanto, una única cola de paquetes recibidos), compartido por todas esas
 conexiones.
\end_layout

\begin_layout Standard
De esta manera, el número de hilos de recepción de paquetes que existen
 en un momento dado será el más reducido posible de acuerdo a las necesidades
 específicas de la aplicación.
\end_layout

\begin_layout Paragraph
Relaciones de la clase 
\family typewriter
NetworkConnection
\end_layout

\begin_layout Standard
La clase 
\family typewriter
NetworkConnection 
\family default
define una interfaz que permite manipular los recursos asignados a una conexión
 de red a un elevado nivel de abstracción.
 Las relaciones existentes entre la clase
\family typewriter
 NetworkConnection
\family default
 y el resto de clases del paquete 
\family typewriter
network
\family default
 aparecen en el diagrama de clases de la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Relaciones-networkConnection"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/DiagramaClasesNetworkConnection.pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Relaciones-networkConnection"

\end_inset

Relaciones de la clase 
\family typewriter
NetworkConnection
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
Para establecer una conexión, es necesario utilizar un objeto 
\family typewriter
Endpoint
\family default
.
 Dependiendo del tipo de conexión (cliente o servidor) y del protocolo utilizado
 (SSL o TCP versión 4), se utiliza una subclase distinta de 
\family typewriter
Endpoint
\family default
.
\end_layout

\begin_layout Standard
Por otra parte, para realizar el envío de datos, el procesamiento de datos
 entrantes, la detección de desconexiones y el cierre ordenado de la conexión
 se utiliza un objeto 
\family typewriter
CygnusCloudProtocolFactory
\family default
 en cada extremo de la comunicación.
\end_layout

\begin_layout Standard
Finalmente, cada conexión también tendrá asociado un hilo de procesamiento
 de los paquetes recibidos, que es una instancia de 
\family typewriter
IncomingDataThread
\family default
.
\end_layout

\begin_layout Subsubsection
La clase 
\family typewriter
NetworkManager
\end_layout

\begin_layout Standard
La clase 
\family typewriter
NetworkConnection
\family default
 permite manipular los recursos asignados a una determinada conexión de
 red.
 Pero para poder comunicar dos máquinas no basta con utilizar objetos 
\family typewriter
NetworkConnection
\family default
: también es necesario disponer de
\end_layout

\begin_layout Itemize
un hilo de envío de paquetes, que envíe todos los paquetes salientes a sus
 destinatarios a través de las conexiones.
\end_layout

\begin_layout Itemize
un hilo que actualice periódicamente el estado de las conexiones, algo imprescin
dible para establecerlas y detectar errores.
\end_layout

\begin_layout Itemize
un hilo que ejecute el bucle reactor de 
\emph on
twisted
\emph default
.
\end_layout

\begin_layout Itemize
mecanismos que permitan construir paquetes que transportan datos del usuario
 de forma correcta (para evitar la aparición de errores relacionados con
 los tipos de paquete y sus prioridades)
\end_layout

\begin_layout Itemize
mecanismos que detecten el uso incorrecto de la red, que facilitarán la
 depuración del código del cliente.
\end_layout

\begin_layout Standard
La clase 
\family typewriter
NetworkManager
\family default
 proporciona una fachada que permite comunicar dos o más máquinas entre
 sí a un nivel de abstracción razonablemente elevado.
 Entre otras cosas, permite a los clientes:
\end_layout

\begin_layout Itemize
crear servidores o conectarse a ellos.
\end_layout

\begin_layout Itemize
crear paquetes ocultando la existencia de los tipos de paquete reservados
 y sus prioridades.
\end_layout

\begin_layout Itemize
intercambiar contenido arbitrario entre varias máquinas diferentes.
\end_layout

\begin_layout Itemize
procesar los datos recibidos de acuerdo a las necesidades de la aplicación.
 
\end_layout

\begin_layout Standard
Las relaciones entre la clase 
\family typewriter
NetworkManager
\family default
 y el resto de clases del paquete 
\family typewriter
Network
\family default
 aparece en el diagrama de clases de la figura 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Relaciones-network-manager"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename graficos/Arquitectura/Vista lógica/DiagramaClasesNetworkManager.pdf
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Relaciones-network-manager"

\end_inset

Relaciones de la clase 
\family typewriter
NetworkManager
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
El hilo de paquetes salientes, 
\family typewriter
OutgoingDataThread
\family default
, está compartido por todas las conexiones, y las utiliza para realizar
 el envío de los paquetes.
 Por su parte, el hilo de actualización del estado de las conexiones (
\family typewriter
ConnectionMonitoringThread
\family default
) llama periódicamente al método de actualización de estado de cada conexión.
\end_layout

\begin_layout Standard
Por otra parte, el hilo 
\family typewriter
TwistedReactorThread 
\family default
no interactúa con ningún otro hilo.
 Su único cometido es ejecutar el bucle reactor de 
\emph on
twisted
\emph default
.
\end_layout

\begin_layout Standard
Los objetos 
\family typewriter
NetworkManager
\family default
 también disponen de métodos para crear paquetes que transportarán los datos
 de los usuarios, lo que nos permite garantizar que el encabezado de los
 paquetes que circulan por la red es siempre correcto, evitando así la aparición
 de comportamientos incorrectos provocados por una prioridad o un tipo de
 paquete incorrectos.
\end_layout

\begin_layout Standard
Finalmente, siempre que se produzcan errores, los objetos 
\family typewriter
NetworkManager 
\family default
lanzarán excepciones del tipo 
\family typewriter
NetworkException
\family default
.
 Si se produce un error en una conexión, la excepción se lanzará al intentar
 utilizarla.
\end_layout

\begin_layout Subsection
El paquete 
\family typewriter
virtualMachineServer
\end_layout

\begin_layout Subsection
El paquete 
\family typewriter
clusterServer
\end_layout

\begin_layout Subsection
El paquete 
\family typewriter
webServer
\end_layout

\begin_layout Standard
En este paquete se trata todo lo relacionado con la gestión de la web de
 CygnusCloud.
 Así en este paquete se incluyen todos los módulos encargados de gestionar
 las funcionalidades de interacción con los usuarios a través de la web
 y los ficheros html y css necesarios para la implementación de las páginas.
 
\end_layout

\begin_layout Subsubsection
Estructura general de la web
\end_layout

\begin_layout Standard
Para llevar a cabo el desarrollo de la web ha sido necesario la utilización
 de un framework web que nos facilitase algunos aspectos y estructurase
 el sistema de forma correcta.
 Para ello, hemos optado por la utilización de Web2Py cuyas principales
 características y funcionamiento explicamos en la sección 
\begin_inset CommandInset ref
LatexCommand ref
reference "sub:Uso-web2py"

\end_inset

.
\end_layout

\begin_layout Standard
Como ya mencionamos en esa sección, web2py estructura las aplicaciones siguiendo
 un modelo vista-controlador.
 Por ello en CygnusCloud ha sido necesario estructurar el código de la web
 en un grupo de control y un grupo de vista.
 A parte de ambos grupos también se han añadido más grupos con ficheros
 estáticos, css, módulos importados y en general todos los ficheros necesarios
 para dar la funcionalidad y el aspecto requeridos en la web.
\end_layout

\begin_layout Standard
Con todo esto, la web de CygnusCloud puede subdividirse en los siguientes
 grupos según su finalidad y tipo:
\end_layout

\begin_layout Itemize
Vistas : Este grupo incluye todos los ficheros de formato html encargados
 de establecer el aspecto de los componentes, su posicionamiento en las
 páginas y su comportamiento.
 Entendemos por comportamiento de un componente, su capacidad para realizar
 ciertas acciones que mejoren la interacción con los usuarios.
 Según las restricciones de web2py será necesario disponer de un fichero
 de vista por cada sección disponible en la web.
 Cada uno de estos ficheros de vista reciben los componentes creados en
 el controlador asociado, ajustan su aspecto al que se mostrará en la web,
 y los posicionan en el lugar deseado.
\end_layout

\begin_layout Itemize
Controladores : Este grupo incluye el conjunto de módulos python que aportan
 todas las funcionalidades que serán gestionadas por la web.
 CygnusCloud dispone de un módulo para cada uno de los tipos de usuarios
 que pueden acceder a la web (alumnos, administradores y estudiantes), un
 módulo para las páginas de acceso público, un módulo para la página que
 contiene el cliente VNC y un módulo appAdmin creado automáticamente por
 web2py para la gestión de las bases de datos.
 Dentro de cada módulo encontramos una función asociada a cada una de las
 secciones que forman la web.
 Hablaremos más en profundidad sobre este tema en la sección 
\begin_inset Note Note
status open

\begin_layout Plain Layout
referencia a sección 
\begin_inset Quotes eld
\end_inset

Secciones y subsecciones
\begin_inset Quotes erd
\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Itemize
Modelos : Este grupo incluye dos módulos python encargados de la creación
 de las bases de datos y las características generales de la aplicación.
 Así, el módulo 
\begin_inset Quotes eld
\end_inset

db.py
\begin_inset Quotes erd
\end_inset

 crea las tablas de la base de datos encargada de la gestión de la información
 en la web.
 El módulo 
\begin_inset Quotes eld
\end_inset

menu.py
\begin_inset Quotes erd
\end_inset

 define las características generales de la aplicación web, tales como su
 logo, su autor, sus tags de busqueda...
 Este par de módulos son creados y exigidos por web2py.
\end_layout

\begin_layout Itemize
Lenguajes : Este grupo incluye los diccionarios de traducción de las páginas
 de la web.
 Estos diccionarios deben ser rellenados por el desarrollador y son usados
 internamente por web2py para traducir todas las palabras de la web que
 aparezcan en los diccionarios.
\end_layout

\begin_layout Itemize
Archivos estáticos : Este grupo incluye los ficheros css y js encargados
 de definir la apariencia de la web, las imágenes y en general cualquier
 fichero que defina algún componente externo que forma parte de la web.
\end_layout

\begin_layout Itemize
Módulos : En este apartado se incluyen todos los módulos python secundarios
 utilizados por los controladores.
 Así, en este grupo se encuentra el conector que permite la interacción
 entre el servidor web y el servidor de cluster.
\end_layout

\begin_layout Subsubsection
Estructura de direcciones
\begin_inset CommandInset label
LatexCommand label
name "sub:Estructura-de-direcciones"

\end_inset


\end_layout

\begin_layout Standard
Con el fin de poder gestionar la web de la forma más modular posible y aprovecha
ndo el flujo de direcciones usadas por web2py vamos a estructurar los diferentes
 apartados de la web en forma de árbol de direcciones tal que cada uno de
 sus nodos podrá realizar saltos a cualquier otro nodo del árbol según las
 acciones realizadas por los usuarios.
 Así el elemento principal será la aplicación en sí (/CygnusCloud).
 A partir de esta dirección comenzarán a surgir las direcciones asociadas
 a las páginas manteniendo la estructura de secciones y subsecciones correspondi
entemente.
 De esta forma, las diferentes URLs sobre las que trabajará la web son:
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/login
\begin_inset Quotes erd
\end_inset

 : Es la página de inicio de sesión donde el usuario introduce su nombre
 y contraseña para iniciar la sesión.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/about
\begin_inset Quotes erd
\end_inset

 : Es la página en la que se habla acerca de CygnusCloud y su finalidad.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/student/runVM
\begin_inset Quotes erd
\end_inset

 : Es la página de arranque de máquinas virtuales para los usuarios.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/runVM/run
\begin_inset Quotes erd
\end_inset

: Es la página de arranque de máquinas virtuales para los administradores.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/runVM/stop
\begin_inset Quotes erd
\end_inset

: Es la página de detención de máquinas virtuales en ejecución para los
 administradores.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/servers/add_servers
\begin_inset Quotes erd
\end_inset

 : Es la página encargada de añadir nuevos servidores y borrar algún servidor
 existente.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/servers/remove_servers
\begin_inset Quotes erd
\end_inset

 : Es la página encargada de eliminar servidores de máquinas virtuales existente
s.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/users/remove
\begin_inset Quotes erd
\end_inset

 : Esta es la página encargada de eliminar a usuarios previamente creados.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/users/add
\begin_inset Quotes erd
\end_inset

 : Es la página encargada de crear nuevos usuarios con las especificaciones
 determinadas por el administrador.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/users/associate_subjects
\begin_inset Quotes erd
\end_inset

 : Es la página encargada de establecer las relaciones entre un usuario
 previamente creado y un grupo de asignatura.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/subjects/add
\begin_inset Quotes erd
\end_inset

 : Esta es la página encargada de crear nuevos grupos de asignaturas con
 la información introducida por el administrador.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/administrator/subjects/remove
\begin_inset Quotes erd
\end_inset

 : Esta es la página encargada de eliminar algún grupo de asignatura existente.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

/CygnusCloud/vncClient/VNCPage
\begin_inset Quotes erd
\end_inset

 : Página que contiene el escritorio de trabajo ejecutado por noVNC.
\end_layout

\begin_layout Standard
La distribución de estas páginas con respecto a su estructura en el flujo
 de direcciones viene representado en el diagrama de la figura 
\begin_inset Note Note
status open

\begin_layout Plain Layout
Insertar diagrama.
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Secciones y subsecciones
\end_layout

\begin_layout Standard
Para poder hacer frente al elevado número de páginas que ofrece CygnusCloud,
 hemos optado por estructurar estas páginas en un sistema de 3 niveles,
 que permite filtrar y estructurar las páginas teniendo en cuenta los privilegio
s de acceso y la finalidad e cada página.
 
\end_layout

\begin_layout Standard
El primer nivel se centra en los privilegios de acceso asociados a cada
 página.
 CygnusCloud agrupa a los usuarios registrados en 3 tipos según los privilegios
 de los que dispongan.
 Estos privilegios dan acceso a unas u otras páginas.
 En la web de CygnusCloud podemos encontrar los siguientes tipos de usuarios:
\end_layout

\begin_layout Itemize
Alumnos : En este tipo se incluyen todos los alumnos que cursan alguna de
 las asignaturas registradas en la web.
 Este tipo de usuarios es el más restringido, dándole únicamente acceso
 a la página de arranque de máquinas virtuales , asociadas a las asignaturas
 matriculadas por el alumno, y a la página de visualización de máquinas
 arrancadas.
\end_layout

\begin_layout Itemize
Profesores : Este tipo incluye a todos los profesores que imparten alguna
 de las asignaturas registradas en la web.
 Dispone de unos privilegios de acceso mayores que el caso del alumno, pudiendo
 acceder, además de las páginas de arranque de máquinas virtuales y gestión
 de máquinas arrancadas, a páginas de creación, edición y borrado de máquinas
 virtuales.
\end_layout

\begin_layout Itemize
Administradores: Este tipo incluye a todos los técnicos y administradores
 encargados de la gestión total de la página.
 Es el tipo más privilegiado, teniendo acceso a las páginas de :
\end_layout

\begin_deeper
\begin_layout Itemize
Arranque de todas máquinas virtuales.
\end_layout

\begin_layout Itemize
Detención de máquinas virtuales arrancadas independientemente del usuarios
 que las arrancó.
\end_layout

\begin_layout Itemize
Gestión de usuarios.
\end_layout

\begin_layout Itemize
Gestión de servidores de máquinas virtuales.
\end_layout

\begin_layout Itemize
Gestión de grupos de asignaturas, así como de las máquinas virtuales asociadas
 a cada grupo.
\end_layout

\end_deeper
\begin_layout Standard
Además de estos tipos de usuarios, CygnusCloud también ofrece acceso a ciertas
 páginas públicas.
 Estas páginas podrán ser vistas por cualquier usuarios que se conecte a
 la página de CygnusCloud, aunque no se encuentre registrado.
 
\end_layout

\begin_layout Standard
Como ya hemos dicho, cada uno de estos tipos del primer nivel concretan
 el conjunto de páginas al cual se quiere acceder.
 
\end_layout

\begin_layout Standard
En el segundo nivel las páginas se encuentran agrupadas por secciones.
 Entendemos como una sección, el conjunto de páginas que abordan un aspecto
 común para un tipo de usuario concreto.
 Cada tipo de usuario tendrá acceso a unas secciones u otras.
 Algunos ejemplos de secciones son la gestión de usuarios, el arranque de
 máquinas virtuales o el inicio de sesión.
 En la tabla 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:Tabla-rtipos-secciones"

\end_inset

puede verse el conjunto de secciones asociadas a cada tipo de usuario.
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Tipo de usuario
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Secciones
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Main
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Login,About
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Student
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
RunVM
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Teacher
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Administrator
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
RunVM, Servers, Users, Subjects
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
Tabla relación tipos de usuario y secciones.
\begin_inset CommandInset label
LatexCommand label
name "tab:Tabla-rtipos-secciones"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
Por último, en el tercer nivel, las páginas se encuentran definidas en subseccio
nes.
 Cada subsección es una página que contiene las funcionalidades relacionadas
 con un aspecto concreto y más limitado que el de la sección que la incluye.
 Existirán por tanto, tantas subsecciones como páginas creadas en la web.
 En la tabla 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:Tabla-seccion-subseccion"

\end_inset

 pueden verse las diferentes subsecciones asociadas a cada sección.
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="7" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Sección
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Subsección
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Login
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
About
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
RunVM
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Run, Stop
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Servers
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Add_servers,Remove_servers
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Users
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Add,Remove,Associate_subjects
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Subjects
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Add, Remove, AddVM
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
Tabla relación secciones y subsecciones
\begin_inset CommandInset label
LatexCommand label
name "tab:Tabla-seccion-subseccion"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
La barra de secciones permanente en la web muestra la distribución de las
 páginas en secciones y subsecciones.
\end_layout

\begin_layout Standard
De cara a la implementación, es necesario ajustar esta estructura para que
 siga el modelo definido por web2py.
 Web2py gestiona sus direcciones con respecto a la estructura de los módulos
 python que actúan como controladores.
 El conjunto de controladores presentes en la web coincide con los tipos
 de usuarios definidos en el primer nivel.
 Así disponemos de 5 controladores:
\end_layout

\begin_layout Itemize
Uno para las páginas de acceso público.
\end_layout

\begin_layout Itemize
Uno para las páginas de los alumnos.
\end_layout

\begin_layout Itemize
Uno para las páginas de los profesores.
\end_layout

\begin_layout Itemize
Uno para las páginas de los administradores.
\end_layout

\begin_layout Itemize
Uno para la página que mantendrá el cliente VNC.
\end_layout

\begin_layout Standard
Este último controlador no corresponde a ningún tipo concreto de usuario
 pero se define a parte ya que su uso es común para todos los usuarios.
 
\end_layout

\begin_layout Standard
Dentro de cada controlador es necesario definir una función python para
 cada una de las secciones del nivel 2 asociadas a este tipo de usuario.
 Así todo el código presente en los controladores debe pertenecer a una
 función, bien una función que defina una determinada sección o bien una
 función auxiliar utilizada por alguna de las funciones principales.
\end_layout

\begin_layout Standard
Por último cada una de las funciones python contendrán un variable que les
 indique cual de las subsecciones del tercer nivel deben controlar en cada
 momento.
\end_layout

\begin_layout Standard
Con respecto a las vistas, el diseño de los niveles se simplifica bastante,
 siendo necesario tener un fichero html para cada una de las secciones del
 segundo nivel.
 El nombre de estos ficheros html deben seguir la siguiente estructura:
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Quotes eld
\end_inset

Nombre del controlador
\begin_inset Quotes erd
\end_inset

/
\begin_inset Quotes erd
\end_inset

nombre de la funcion
\begin_inset Quotes erd
\end_inset

.html
\end_layout

\begin_layout Standard
A modo de resumen, el esquema 
\begin_inset Note Note
status open

\begin_layout Plain Layout
referencia a esquema
\end_layout

\end_inset

 muestra como CygnusCloud estructura sus páginas en estos 3 niveles.
 Como podemos observar, las rutas de direcciones de las que hablamos en
 la sección 
\begin_inset CommandInset ref
LatexCommand ref
reference "sub:Estructura-de-direcciones"

\end_inset

 coinciden con la estructura en los 3 niveles.
\end_layout

\begin_layout Subsubsection
La barra de direcciones
\end_layout

\begin_layout Standard
Con el fin de permitir a los usuarios acceder a las diferentes páginas de
 forma directa sin necesidad de utilizar redirecciones a páginas intermedias,
 la web dispone de una barra de direcciones permanente que permite al usuario
 redirigirse a cualquier página dentro de su rango de acción.
 De esta forma dependiendo del tipo de usuarios dispondremos de las siguientes
 barras:
\end_layout

\begin_layout Itemize
barra de direcciones para páginas de acceso público.
 En esta barra aparecen las páginas de inicio de sesión y de 
\begin_inset Quotes eld
\end_inset

Acerca de
\begin_inset Quotes erd
\end_inset

, a las cuales pueden acceder libremente cualquier usuario que entre en
 la web.
\end_layout

\begin_layout Itemize
barra de direcciones para alumnos.
 Esta barra incluye la página de arranque de máquinas virtuales y está restringi
da a usuarios de tipo alumno registrados en la web.
\end_layout

\begin_layout Itemize
barra de direcciones para administradores.
 Esta barra contiene todas las páginas de gestión de servidores, asignaturas
 y usuarios.
 Además contiene la página de arranque de máquinas virtuales.
 Su acceso está restringido a usuarios de tipo administrador.
\end_layout

\begin_layout Section
Vista de procesos
\end_layout

\begin_layout Section
Vista de despliegue
\end_layout

\begin_layout Section
Vista de implementación
\end_layout

\end_body
\end_document
